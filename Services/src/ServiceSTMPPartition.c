#include <stdint.h>
#include <stdbool.h>
#include <stdlib.h>
#include <stdio.h>
#include <stdarg.h>

#include "tusb.h"

/* System serive includes. */
#include "ServiceUSBDevice.h"
#include "ServiceRawFlash.h"
#include "ServiceSTMPPartition.h"

/* Library includes. */
#include "regsuartdbg.h"
#include "irq.h"
#include "display.h"

/* Kernel includes. */
#include "FreeRTOS.h"
#include "task.h"
#include "queue.h"

/*
NCB		0		BCB


LDLB	512		BCB
BCB		513


DBBT	1024	BCB

BBCR	1032	BCB

REGION	1408	BCB
		1409	BCB
		1410	BCB
		1411	BCB

*/



const unsigned char STMP_meta[] = {
	0xFF, 0x00, 0x53, 0x54, 0x4D, 0x50, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF 
};

const unsigned char BCB_meta[] = {		//BCB< >
	0xFF, 0xFF, 0x42, 0x43, 0x42, 0x20, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF 
};

const unsigned char ZERO_meta[] = {
	0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF 
};

const unsigned char NCB_s00[] = {
	
	0x53, 0x54, 0x4D, 0x50, 0x2D, 0x1E, 0x19, 0x06, 0x00, 0x08, 0x00, 0x00, 0x40, 0x08, 0x00, 0x00, 
	0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x4E, 0x43, 0x42, 0x20, 
	0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 
	0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x52, 0x42, 0x49, 0x4E, 0x01, 0x00, 0x00, 0x00, 0xFE, 0x2D, 0x1E, 0x19, 0x06, 0x00, 0x00, 0x00

};


const unsigned char LDLB_S01[] = {/*
	0x53, 0x54, 0x4D, 0x50, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x01, 0x00, 0x00, 0x00,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x4C, 0x44, 0x4C, 0x42,
	0x00, 0x00, 0x00, 0x00, 0x80, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x0C, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0xC0, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x0C, 0x00, 0x00,
	0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x04, 0x00, 0x00, 0xC0, 0x04, 0x00, 0x00,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0x52, 0x42, 0x49, 0x4C, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF*/
	
    0x53, 0x54, 0x4D, 0x50, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x01, 0x00, 0x00, 0x00, 
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x4C, 0x44, 0x4C, 0x42, 
    0x00, 0x00, 0x00, 0x00, 0x80, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x80, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 
    0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x04, 0x00, 0x00, 0xC0, 0x04, 0x00, 0x00, 
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 
    0x52, 0x42, 0x49, 0x4C, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF
	
};

const unsigned char DBBT[] = {
	0x53, 0x54, 0x4D, 0x50, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 
	0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44, 0x42, 0x42, 0x54, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x52, 0x42, 0x49, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

const unsigned char BBCR[] = {
	0x53, 0x54, 0x4D, 0x50, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x42, 0x42, 0x43, 0x52, 
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 
	0x52, 0x42, 0x49, 0x42, 0x01, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF
};



NandConfigBlockInfo_t *p_NandConfigBlock;

NandConfigBlockInfo_t SysNandConfigBlock;


NandConfigBlockRegionInfo_t Regions[10];
unsigned int nRegion = 0;
unsigned char _isRawFlash = true;


unsigned int LDLBBlockPos = 0;

void vScanAndBuildRegionInfo(){
	unsigned int block;
	unsigned int *buffer;
	
	nRegion = 0 ;
	buffer = pvPortMalloc(2048);
	
	for(block = 0; block < 64; block++){
		xReadFlashPages( block * 64 + 1, 1 ,buffer, 5000);
		
		p_NandConfigBlock = (NandConfigBlockInfo_t *)buffer;
		
		if((p_NandConfigBlock->iMagicCookie == NAND_CONFIG_BLOCK_MAGIC_COOKIE) && 
		
		   (p_NandConfigBlock->iVersionNum  == NAND_CONFIG_BLOCK_VERSION)){
			   
			   memcpy(&SysNandConfigBlock,p_NandConfigBlock,sizeof(SysNandConfigBlock));
			   _isRawFlash = false;
			   printf("Found %d STMP Region(s).\n", SysNandConfigBlock.iNumRegions);
				
			   for(int i=0 ; i<SysNandConfigBlock.iNumRegions; i++ ){
				   Regions[i].eDriveType = SysNandConfigBlock.Regions[i].eDriveType;
				   Regions[i].wTag = SysNandConfigBlock.Regions[i].wTag;
				   Regions[i].iNumBlks = SysNandConfigBlock.Regions[i].iNumBlks;
				   Regions[i].iChip = SysNandConfigBlock.Regions[i].iChip;
				   Regions[i].iStartBlock = SysNandConfigBlock.Regions[i].iStartBlock;
				   nRegion++;
				   printf("%d: DriveType: %d, Block Size: %d, Start Block: %d, Tag: %08X\n",i, 
																SysNandConfigBlock.Regions[i].eDriveType,
																SysNandConfigBlock.Regions[i].iNumBlks,
																SysNandConfigBlock.Regions[i].iStartBlock,
																SysNandConfigBlock.Regions[i].wTag
																
																);
			   }
			   LDLBBlockPos = block;
			   printf("LDLBBlockPos=%d\n",LDLBBlockPos);
			   break;
		   }
	}
	
	vPortFree(buffer);
	
}


void modifyRegion(unsigned int regionNum, unsigned int newStartBlock, unsigned int newBlockSize, unsigned int tag){
	
	if(_isRawFlash)
		return;
	
	Regions[regionNum].iNumBlks = newBlockSize;
	Regions[regionNum].iStartBlock = newStartBlock;
	Regions[regionNum].wTag = tag;
	
	SysNandConfigBlock.Regions[regionNum].iNumBlks = newBlockSize;
	SysNandConfigBlock.Regions[regionNum].iStartBlock = newStartBlock;
	SysNandConfigBlock.Regions[regionNum].wTag = tag;
	
}





void saveRegionTable(){
	

	if(_isRawFlash)
		return;
	
	unsigned char *buffer;

	buffer = pvPortMalloc(2048);

	xEraseFlashBlocks(LDLBBlockPos ,1,5000);
	vTaskDelay(10);
	
	buffer = pvPortMalloc(2048);
	memset(buffer,0xFF,2048);
	memcpy(buffer,LDLB_S01,sizeof(LDLB_S01));
	xWriteFlashPages(LDLBBlockPos * 64,  1, buffer, BCB_meta, 5000);
	
	
	memset(buffer,0xFF,2048);
	memcpy(buffer,&SysNandConfigBlock,sizeof(SysNandConfigBlock));
	xWriteFlashPages(LDLBBlockPos * 64 + 1,  1, buffer, BCB_meta, 5000);

	vPortFree(buffer);
	
	printf("saveRegionTable\n");
	
}


void resetFlashRegionInfo(){
	

	
	//if(_isRawFlash){
		LDLBBlockPos = 8;
		xEraseFlashBlocks(LDLBBlockPos ,1,5000);
		
		unsigned char *buffer;
		
		buffer = pvPortMalloc(2048);
		memset(buffer,0xFF,2048);
		memcpy(buffer,LDLB_S01,sizeof(LDLB_S01));
		xWriteFlashPages(LDLBBlockPos * 64,  1, buffer, BCB_meta, 5000);
		
		memset(buffer,0xFF,2048);
		
		SysNandConfigBlock.iMagicCookie = NAND_CONFIG_BLOCK_MAGIC_COOKIE;
		SysNandConfigBlock.iVersionNum = NAND_CONFIG_BLOCK_VERSION;
		SysNandConfigBlock.iNumBadBlks = 0xFFFFFFFF;
		SysNandConfigBlock.iNumRegions = 6;
		SysNandConfigBlock.iNumReservedBlocks = 0x2A;
		
		for(int i=0; i<3 ; i++){
			SysNandConfigBlock.Regions[i].eDriveType = kDriveTypeSystem;
			SysNandConfigBlock.Regions[i].wTag = 0x50;
			SysNandConfigBlock.Regions[i].iNumBlks = 8;
			SysNandConfigBlock.Regions[i].iChip = 0;
			SysNandConfigBlock.Regions[i].iStartBlock = 22;
		}
			SysNandConfigBlock.Regions[1].wTag = 0x60;
			SysNandConfigBlock.Regions[2].wTag = 0x70;
			
			SysNandConfigBlock.Regions[3].eDriveType = kDriveTypeData;
			SysNandConfigBlock.Regions[3].wTag = 0x00;
			SysNandConfigBlock.Regions[3].iNumBlks = 978;
			SysNandConfigBlock.Regions[3].iChip = 0;
			SysNandConfigBlock.Regions[3].iStartBlock = 30;	

			SysNandConfigBlock.Regions[4].eDriveType = kDriveTypeHidden;
			SysNandConfigBlock.Regions[4].wTag = 0x03;
			SysNandConfigBlock.Regions[4].iNumBlks = 8;
			SysNandConfigBlock.Regions[4].iChip = 0;
			SysNandConfigBlock.Regions[4].iStartBlock = 1008;				
		
			SysNandConfigBlock.Regions[5].eDriveType = kDriveTypeHidden;
			SysNandConfigBlock.Regions[5].wTag = 0x02;
			SysNandConfigBlock.Regions[5].iNumBlks = 8;
			SysNandConfigBlock.Regions[5].iChip = 0;
			SysNandConfigBlock.Regions[5].iStartBlock = 1016;			
		
		memcpy(buffer,&SysNandConfigBlock,sizeof(SysNandConfigBlock));
		
		xWriteFlashPages(LDLBBlockPos * 64 + 1,  1, buffer, BCB_meta, 5000);
		
		xEraseFlashBlocks(0 ,1,5000);
		memset(buffer,0x00,2048);
		memcpy(buffer, &NCB_s00, sizeof(NCB_s00));
		xWriteFlashPages(0,1,buffer,BCB_meta,5000);
		
		
		xEraseFlashBlocks(16 ,1,5000);
		memset(buffer,0xFF,2048);
		memcpy(buffer, &DBBT, sizeof(DBBT));
		xWriteFlashPages(1024,1,buffer,ZERO_meta,5000);
		
		memset(buffer,0xFF,2048);
		memcpy(buffer, &BBCR, sizeof(BBCR));
		xWriteFlashPages(1032,1,buffer,ZERO_meta,5000);
		
	
		
		_isRawFlash = false;
		
		vPortFree(buffer);
		
	/*}else{
		
		modifyRegion(0, 22, 8, 0x50);		//system 1
		modifyRegion(1, 22, 8, 0x60);		//system 2
		modifyRegion(2, 22, 8, 0x70);		//system 3
		
		modifyRegion(3, 30, 978, 0);		//data 1
		
		modifyRegion(4, 1008, 8, 3);		//Hidden 1
		modifyRegion(5, 1016, 8, 2);		//Hidden 2
		
		saveRegionTable();
		
	}*/
	
	/*
	for(int i=22; i < 22 + 8; i++){
		xEraseFlashBlocks(i ,1,5000);
		vTaskDelay(5);
	}
	
	*/ 
	
}

void eraseBootimgRegion(){
	for(int i=22; i < 22 + 8; i++){
		xEraseFlashBlocks(i ,1,5000);
		vTaskDelay(5);
	}
}

void installBootimgInPage(unsigned int page, void *buffer){
	xWriteFlashPages(22 * 64 + page,1, buffer, STMP_meta, 5000);
}


/*
void lockFlash(bool lock){
	if(lock){
		_isRawFlash = true;
	}else{
		_isRawFlash = false;
	}
}
*/
bool isRawFlash()
{
	return _isRawFlash;
}

unsigned int getDataRegonTotalBlocks(){
	
	/*
	if(_isRawFlash){
		return 0;
	}
	for(int i = 0; i < nRegion; i++){
		if(Regions[i].eDriveType == kDriveTypeData){
			return Regions[i].iNumBlks;
		}
	}
	*/
	return 978;
}

unsigned int getDataRegonStartBlock(){
	/*
	if(_isRawFlash){
		return 0;
	}
	for(int i = 0; i < nRegion; i++){
		if(Regions[i].eDriveType == kDriveTypeData){
			return Regions[i].iStartBlock;
		}
	}*/
	
	return 30;
}

void vSTMPPartition( void *pvParameters )
{
	vTaskDelay(1);
	
	vScanAndBuildRegionInfo();
	
	for(;;) {
		vTaskSuspend(NULL);
	}
	
	
}